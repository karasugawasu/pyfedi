<div class="row position-relative post_full {{ ' my_post' if current_user.get_id() == post.user_id }}">
    <div class="col post_col {% if post.type == POST_TYPE_IMAGE %}post_col post_type_image{% else %}post_type_normal{% endif %} {{ 'reported' if post.has_been_reported() }}">
        {% if post.type != POST_TYPE_EVENT or (post.type == POST_TYPE_EVENT and post.image_id is none) -%}
            {% include "post/_breadcrumb_nav.html" %}
        {% endif %}
        <div class="post_header">
            <div class="post_header_row d-flex justify-content-between align-items-start">
                <div class="post_header_left">
                    <h1 class="mt-2 post_title" lang="{{ post.language_code() }}">
                        {{ post.title }}
                        {% if post.nsfw -%}
                            <span class="warning_badge nsfw" title="{{ _('Not safe for work') }}">
                                {{ _('nsfw') }}
                            </span>
                        {% endif -%}
                        {% if post.nsfl -%}
                            <span class="warning_badge nsfl" title="{{ _('Potentially emotionally scarring content') }}">
                                {{ _('nsfl') }}
                            </span>
                        {% endif -%}
                        {% if post.ai_generated -%}
                            <span class="warning_badge ai_generated" title="{{ _('This post contains AI generated content') }}">
                                {{ _('AI') }}
                            </span>
                        {% endif -%}
                    </h1>
                </div>
                {% if post.type == POST_TYPE_LINK and post.image_id and not (post.url and 'youtube.com' in post.url) and not post.deleted -%}
                    <div class="post_header_thumb flex-shrink-0">
                        <a href="{{ post.url }}" target="_blank" rel="nofollow ugc" class="post_thumb_link" aria-label="Open link">
                            <img
                                src="{{ post.image.thumbnail_url() }}"
                                alt="{{ post.image.alt_text if post.image.alt_text else '' }}"
                                width="{{ post.image.thumbnail_width }}"
                                height="{{ post.image.thumbnail_height }}"
                                loading="lazy"
                                decoding="async"
                            />
                            <span class="post_thumb_icon fe fe-external" aria-hidden="true"></span>
                        </a>
                    </div>
                {% elif post.type == POST_TYPE_LINK and not post.image_id and not post.deleted -%}
                    <div class="post_header_thumb flex-shrink-0">
                        <a href="{{ post.url }}" target="_blank" rel="nofollow ugc" class="post_thumb_link" aria-label="Open link">
                            <span class="post_thumb_fallback fe fe-external" aria-hidden="true"></span>
                        </a>
                    </div>
                {% elif post.type == POST_TYPE_IMAGE and not post.deleted -%}
                    <div class="post_header_thumb flex-shrink-0">
                        <a href="{{ post.url }}" target="_blank" rel="nofollow ugc" class="post_thumb_link header_img" aria-label="Open link">
                            <img
                                src="{{ post.image.thumbnail_url() }}"
                                alt="{{ post.image.alt_text if post.image.alt_text else '' }}"
                                loading="lazy"
                                decoding="async"
                            />
                            <span class="post_thumb_icon fe fe-image" aria-hidden="true"></span>
                        </a>
                    </div>
                {% endif -%}
            </div>
        </div>
        <div class="mb-2">
            {% if post.has_been_reported() -%}
            <a href="{{ url_for('community.community_moderate', actor=post.community.link()) }}"><span class="red fe fe-report" title="{{ _('Reported. Check post for issues.') }}"></span></a>
            {% endif -%}
            {% if post.type != POST_TYPE_EVENT -%}
                <small>{{ _('submitted') }} <time datetime="{{ arrow.get(post.posted_at).format('YYYY-MM-DD HH:mm:ss ZZ') }}" title="{{ arrow.get(post.posted_at).format('YYYY-MM-DD HH:mm:ss ZZ') }}">{{ arrow.get(post.posted_at).humanize(locale=locale) }}</time> by
                    {% if not post.deleted or post.community.is_moderator() or post.community.is_owner() or current_user.get_id() in admin_ids -%}
                        {{ render_username(post.author, htmx_redirect_back_to=request.path, user_notes=user_notes, current_user=current_user, admin_ids=admin_ids, low_bandwidth=low_bandwidth) }}
                    {% else -%}
                        [{{ _('deleted') }}]
                    {% endif -%}
                {% if user_flair and post.author.id in user_flair -%}
                    <span class="user_flair">{{ user_flair[post.author.id] }}</span>
                {% elif post.author.id in user_pronouns and user_pronouns[post.author.id] not in post.author.display_name() %}
                    <span class="user_flair pronouns">{{ user_pronouns[post.author.id] }}</span>
                {% endif %}
                {% if post.edited_at -%} edited <time datetime="{{ arrow.get(post.posted_at).format('YYYY-MM-DD HH:mm:ss ZZ') }}" title="{{ arrow.get(post.posted_at).format('YYYY-MM-DD HH:mm:ss ZZ') }}">{{ arrow.get(post.edited_at).humanize(locale=locale) }}</time>{% endif -%}</small>
            {% endif -%}
        </div>
        {% if post.type == POST_TYPE_LINK and post.url and not post.deleted -%}
            {% if post.url.endswith('.mp3') -%}
                <p>
                    <audio controls preload="{{ 'none' if low_bandwidth else 'metadata' }}" src="{{ post.url }}"></audio>
                </p>
            {% elif post.url.endswith('.mp4') or post.url.endswith('.webm') -%}
                <p>
                    <video class="responsive-video" controls preload="{{ 'metadata' if low_bandwidth else 'auto' }}" {{ 'loop' if post.community.loop_videos() }}>
                        {% if post.url.endswith('.mp4') -%}
                            <source src="{{ post.url }}" type="video/mp4" />
                        {% elif post.url.endswith('.webm') -%}
                            <source src="{{ post.url }}" type="video/webm" />
                        {% endif -%}
                    </video>
                </p>
            {% elif post.url.startswith('https://streamable.com') -%}
                <div style="padding-bottom: 56.25%; position: relative;">
                    <iframe style="position: absolute; top: 0px; left: 0px; width: 100%; height: 100%;" src="{{ post.url.replace('streamable.com/', 'streamable.com/e/') }}" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture; fullscreen"  width="100%" height="100%" frameborder="0"></iframe>
                </div>
            {% elif post.url.startswith('https://www.redgifs.com/watch/') -%}
                <div style="padding-bottom: 56.25%; position: relative;">
                    <iframe style="position: absolute; top: 0px; left: 0px; width: 100%; height: 100%;" src="{{ post.url.replace('redgifs.com/watch/', 'redgifs.com/ifr/') }}" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture; fullscreen"  width="100%" height="100%" frameborder="0"></iframe>
                </div>
            {% endif -%}
            {% if 'youtube.com' in post.url -%}
                <div style="padding-bottom: 56.25%; position: relative;">
                    <iframe style="position: absolute; top: 0px; left: 0px; width: 100%; height: 100%;" src="https://www.youtube-nocookie.com/embed/{{ post.youtube_embed() }}" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture; fullscreen"  width="100%" height="100%" frameborder="0"></iframe>
                </div>
            {% endif -%}
            {% set mastodon_hosts = [
                'https://mastodon.social/',
                'https://mstdn.jp/',
                'https://infosec.exchange/',
                'https://mstdn.social/',
                'https://mas.to/',
                'https://precure.ml/',
                'https://md.korako.me/',
                'https://mstdn.delmulin.com/',
                'https://mstdn.b-shock.org/',
                'https://mastodon.nzoss.nz/',
                'https://fedibird.com',
                'https://foresdon.jp'
            ] %}
            {% if post.url and
                mastodon_hosts
                | select('in', post.url)
                | list
                | length > 0
            -%}
                <blockquote class="mastodon-embed" data-embed-url="{{ post.url }}/embed" style="background: #FCF8FF; border-radius: 8px; border: 1px solid #C9C4DA; margin: 0; max-width: 540px; min-width: 270px; overflow: hidden; padding: 0;"> <a href="{{ post.url }}" target="_blank" style="align-items: center; color: #1C1A25; display: flex; flex-direction: column; font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Oxygen, Ubuntu, Cantarell, 'Fira Sans', 'Droid Sans', 'Helvetica Neue', Roboto, sans-serif; font-size: 14px; justify-content: center; letter-spacing: 0.25px; line-height: 20px; padding: 24px; text-decoration: none;"> <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="32" height="32" viewBox="0 0 79 75"><path d="M63 45.3v-20c0-4.1-1-7.3-3.2-9.7-2.1-2.4-5-3.7-8.5-3.7-4.1 0-7.2 1.6-9.3 4.7l-2 3.3-2-3.3c-2-3.1-5.1-4.7-9.2-4.7-3.5 0-6.4 1.3-8.6 3.7-2.1 2.4-3.1 5.6-3.1 9.7v20h8V25.9c0-4.1 1.7-6.2 5.2-6.2 3.8 0 5.8 2.5 5.8 7.4V37.7H44V27.1c0-4.9 1.9-7.4 5.8-7.4 3.5 0 5.2 2.1 5.2 6.2V45.3h8ZM74.7 16.6c.6 6 .1 15.7.1 17.3 0 .5-.1 4.8-.1 5.3-.7 11.5-8 16-15.6 17.5-.1 0-.2 0-.3 0-4.9 1-10 1.2-14.9 1.4-1.2 0-2.4 0-3.6 0-4.8 0-9.7-.6-14.4-1.7-.1 0-.1 0-.1 0s-.1 0-.1 0 0 .1 0 .1 0 0 0 0c.1 1.6.4 3.1 1 4.5.6 1.7 2.9 5.7 11.4 5.7 5 0 9.9-.6 14.8-1.7 0 0 0 0 0 0 .1 0 .1 0 .1 0 0 .1 0 .1 0 .1.1 0 .1 0 .1.1v5.6s0 .1-.1.1c0 0 0 0 0 .1-1.6 1.1-3.7 1.7-5.6 2.3-.8.3-1.6.5-2.4.7-7.5 1.7-15.4 1.3-22.7-1.2-6.8-2.4-13.8-8.2-15.5-15.2-.9-3.8-1.6-7.6-1.9-11.5-.6-5.8-.6-11.7-.8-17.5C3.9 24.5 4 20 4.9 16 6.7 7.9 14.1 2.2 22.3 1c1.4-.2 4.1-1 16.5-1h.1C51.4 0 56.7.8 58.1 1c8.4 1.2 15.5 7.5 16.6 15.6Z" fill="currentColor"/></svg> <div style="color: #787588; margin-top: 16px;"></div> <div style="font-weight: 500;">View on Mastodon</div> </a> </blockquote> <script data-allowed-prefixes="{{ post.url_domain() }}" async src="/mastodon-embed.js" nonce="{{ g.nonce }}"></script>
            {% endif -%}
            {% set misskey_hosts = [
                'https://misskey.delmulin.com/',
                'https://mk.precure.fun/',
                'https://mk.xiupos.net/',
                'https://misskey.cloud'
            ] %}
            {% if post.url and
                misskey_hosts
                | select('in', post.url)
                | list
                | length > 0
            -%}
                {% set url = post.url.split('?')[0] %}
                {% if url and '/notes/' in url -%}
                    {% set note_id = url.split('/notes/')[-1] %}
                    {% set embed_id = 'v1_' ~ note_id %}
                    {% set embed_url = url | replace('/notes/', '/embed/notes/') %}
                    <iframe
                        src="{{ embed_url }}"
                        data-misskey-embed-id="{{ embed_id }}"
                        loading="lazy"
                        referrerpolicy="strict-origin-when-cross-origin"
                        style="border:none;width:100%;max-width:500px;height:300px;color-scheme:light dark;"
                    ></iframe>
                    <script defer src="{{ post.url_domain() }}embed.js" nonce="{{ g.nonce }}"></script>
                {% endif -%}
            {% endif -%}
        {% elif post.type == POST_TYPE_VIDEO and post.url and not post.deleted -%}
            <p>
                <a href="{{ post.url }}" rel="nofollow ugc" target="_blank" class="post_link" aria-label="Go to post url">
                    {{ post.url|shorten_url }}
                    <span class="fe fe-external"></span>
                </a>
            </p>
            {% if post.url.endswith('.mp4') or post.url.endswith('.webm') or '.mp4?' in post.url or '.webm?' in post.url -%}
                <p>
                    <video class="responsive-video" controls preload="{{ 'none' if low_bandwidth else 'auto' }}" {{ 'autoplay muted' if autoplay }} {{ 'loop' if post.community.loop_videos() }}>
                        {% if post.url.endswith('.mp4') or '.mp4?' in post.url -%}
                            <source src="{{ post.url }}" type="video/mp4" />
                        {% elif post.url.endswith('.webm') or '.webm?' in post.url -%}
                            <source src="{{ post.url }}" type="video/webm" />
                        {% endif -%}
                    </video>
                </p>
            {% elif post.url.startswith('https://vimeo.com') -%}
                <div style="padding-bottom: 56.25%; position: relative;">
                    <iframe style="position: absolute; top: 0px; left: 0px; width: 100%; height: 100%;" src="{{ post.url.replace('vimeo.com/', 'player.vimeo.com/video/') }}" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture; fullscreen"  width="100%" height="100%" frameborder="0"></iframe>
                </div>
            {% elif post.url.startswith('https://streamable.com') -%}
                <div style="padding-bottom: 56.25%; position: relative;">
                    <iframe style="position: absolute; top: 0px; left: 0px; width: 100%; height: 100%;" src="{{ post.url.replace('streamable.com/', 'streamable.com/e/') }}" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture; fullscreen"  width="100%" height="100%" frameborder="0"></iframe>
                </div>
            {% elif post.url.startswith('https://www.redgifs.com/watch/') -%}
                <div style="padding-bottom: 56.25%; position: relative;">
                    <iframe style="position: absolute; top: 0px; left: 0px; width: 100%; height: 100%;" src="{{ post.url.replace('redgifs.com/watch/', 'redgifs.com/ifr/') }}" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture; fullscreen"  width="100%" height="100%" frameborder="0"></iframe>
                </div>
            {% elif post.url.startswith('https://loops.video/') and (post.image.source_url.endswith('.mp4') or post.image.source_url.endswith('.webm')) -%}
                <p>
                    <video class="responsive-video" controls preload="{{ 'none' if low_bandwidth else 'auto' }}" {{ 'autoplay muted' if autoplay }} {{ 'loop' if post.community.loop_videos() }}>
                        {% if post.image.source_url.endswith('.mp4') -%}
                            <source src="{{ post.image.source_url }}" type="video/mp4" />
                        {% elif post.image.source_url.endswith('.webm') -%}
                            <source src="{{ post.image.source_url }}" type="video/webm" />
                        {% endif -%}
                    </video>
                </p>
            {% endif -%}
            {% if 'youtube.com' in post.url -%}
                <div style="padding-bottom: 56.25%; position: relative;">
                    <iframe style="position: absolute; top: 0px; left: 0px; width: 100%; height: 100%;" src="https://www.youtube-nocookie.com/embed/{{ post.youtube_embed() }}" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture; fullscreen"  width="100%" height="100%" frameborder="0"></iframe>
                </div>
            {% endif -%}
            {% if 'videos/watch' in post.url -%}
                <div style="padding-bottom: 56.25%; position: relative;">
                    <iframe style="position: absolute; top: 0px; left: 0px; width: 100%; height: 100%;" src="{{ post.peertube_embed() }}" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture; fullscreen"  width="100%" height="100%" frameborder="0"></iframe>
                </div>
            {% endif -%}
        {% elif post.type == POST_TYPE_IMAGE and not post.deleted -%}
            
        {% elif post.type == POST_TYPE_EVENT and not post.deleted -%}
            <div class="post_event">
                <p>
                    <strong>{{ _('When') }}:</strong>
                    <br>
                    <time class="convert_to_local">{{ event.start.strftime('%Y-%m-%dT%H:%M:%SZ') }}</time> -
                    <time class="convert_to_local">{{ event.end.strftime('%Y-%m-%dT%H:%M:%SZ') }}</time>
                </p>
                {% if event.online -%}
                    <p>
                        <strong>{{ _('Online Event') }}:</strong>
                        <br>
                        <a href="{{ event.online_link }}" target="_blank" rel="nofollow ugc">
                            {{ event.online_link }} <span class="fe fe-external"></span>
                        </a>
                    </p>
                {% else -%}
                    <p>
                        <strong>{{ _('Location') }}:</strong><br>
                        {% if event.location.address -%}{{ event.location.address }}<br>{% endif -%}
                        {% if event.location.city -%}{{ event.location.city }}{% endif -%}
                        {% if event.location.country -%}{% if event.location.city %}, {% endif %}{{ event.location.country }}{% endif -%}
                    </p>
                {% endif -%}
                {% if event.max_attendees -%}
                    <p>
                        <strong>{{ _('Max Attendees') }}:</strong>
                        <br>
                        {{ event.max_attendees }}
                    </p>
                {% endif -%}
                {% if event.join_mode -%}
                    <p>
                        <strong>{{ _('Join Mode') }}:</strong>
                        <br>
                        {{ event.join_mode|title }}
                    </p>
                {% endif -%}
            </div>
        {% else -%}
            {% if post.image_id and not (post.url and 'youtube.com' in post.url) -%}
                <a href="{{ post.image.view_url() }}" target="_blank" class="post_link" aria-label="Go to video" rel="nofollow ugc">
                    <img src="{{ post.image.thumbnail_url() }}" alt="{{ post.image.alt_text if post.image.alt_text else post.title }}"
                            width="{{ post.image.thumbnail_width }}" height="{{ post.image.thumbnail_height }}" loading="lazy" />
                </a>
            {% endif -%}
        {% endif -%}
        <div class="post_body" lang="{{ post.language_code() }}">
            {{ post.body_html | community_links | feed_links| person_links | safe if post.body_html and not post.deleted else '' }}
            {% if archive_link -%}
                <p>
                    <a href="{{ archive_link }}" rel="nofollow ucg noindex" target="_blank">
                        {{ _('Archive.ph link') }} <span class="fe fe-external"></span>
                    </a>
                </p>
            {% endif -%}
            {% if post.licence_id -%}
                <p>
                    {{ _('Licence') }}: {{ post.licence.name }}
                </p>
            {% endif -%}
        </div>
        {% if post.type == POST_TYPE_POLL and not post.deleted -%}
            <div class="post_poll" lang="{{ post.language_code() }}">
                {% if poll_finished and poll_total_votes == 0 -%}
                    <p>
                        {{ _('The poll has finished, yet no votes were cast.') }}
                    </p>
                {% else -%}
                    {% if has_voted -%}
                        <ul>
                            {% for choice in poll_choices -%}
                                <li>
                                    <div class="vote_bar">
                                        <p class="mb-0 mt-3">
                                            {{ choice.choice_text }}
                                        </p>
                                        <div class="vote_score" style="width: {{ choice.percentage(poll_total_votes) }}%">
                                            {{ choice.percentage(poll_total_votes) }}%
                                        </div>
                                    </div>
                                </li>
                            {% endfor -%}
                        </ul>
                    {% else -%}
                        <div id="pollResults" class="d-none mb-4">
                            {% if poll_total_votes and poll_total_votes > 0 %}
                            <ul>
                                {% for choice in poll_choices -%}
                                    <li>
                                        <div class="vote_bar">
                                            <p class="mb-0 mt-3">
                                                {{ choice.choice_text }}
                                            </p>
                                            <div class="vote_score" style="width: {{ choice.percentage(poll_total_votes) }}%">
                                                {{ choice.percentage(poll_total_votes) }}%
                                            </div>
                                        </div>
                                    </li>
                                {% endfor -%}
                            </ul>
                            {% else -%}
                                <p>{{ _('No votes have been cast yet.') }}</p>
                            {% endif -%}
                            <p class="small"><a href="#" id="showVotingForm">{{ _('Show voting form') }}</a></p>
                        </div>
                        <div id="pollVotingForm" class="mb-4">
                            {% if current_user.is_authenticated -%}
                                <form action='/poll/{{ post.id }}/vote' method="post">
                            {% else -%}
                                <form action='/auth/login' method="get">
                                    <input type="hidden" name="next" value="{{ post.slug }}">
                            {% endif -%}
                            <ul>
                                {% for choice in poll_choices -%}
                                    {% if poll_data.mode == 'single' -%}
                                        <li>
                                            <label for="choice_{{ choice.id }}">
                                                <input type="radio" name="poll_choice" id="choice_{{ choice.id }}" required value="{{ choice.id }}"> {{ choice.choice_text }}
                                            </label>
                                        </li>
                                    {% else -%}
                                        <li>
                                            <label for="choice_{{ choice.id }}">
                                                <input type="checkbox" name="poll_choice[]" id="choice_{{ choice.id }}" value="{{ choice.id }}"> {{ choice.choice_text }}
                                            </label>
                                        </li>
                                    {% endif -%}
                                {% endfor -%}
                            </ul>
                            <input type="hidden" name="csrf_token" value="{{ cs }}" />
                            <input type="submit" class="btn btn-primary" value="{{ _('Vote') }}"> <a href="#" id="viewPollResults" class="small">{{ _('View results') }}</a>
                            </form>
                        </div>
                    {% endif -%}
                    <p>{{ _('Total votes: %(total_votes)d.', total_votes=poll_total_votes) }}</p>
                    <p>{{ _('Poll closes') }} {{ arrow.get(poll_data.end_poll).humanize(locale=locale) }}.</p>
                {% endif -%}
                {% if poll_results and poll_total_votes == 0 -%}
                    <p>
                        {{ _('The poll has finished, yet no votes were cast.') }}
                    </p>
                {% elif poll_results and poll_total_votes -%}
                    <ul>
                        {% for choice in poll_choices -%}
                            <li>
                                <div class="vote_bar">
                                    <p class="mb-0 mt-3">
                                        {{ choice.choice_text }}
                                    </p>
                                    <div class="vote_score" style="width: {{ choice.percentage(poll_total_votes) }}%">
                                        {{ choice.percentage(poll_total_votes) }}%
                                    </div>
                                </div>
                            </li>
                        {% endfor -%}
                    </ul>
                    <p>
                        {{ _('Total votes: %(total_votes)d.', total_votes=poll_total_votes) }}
                    </p>
                    <p>
                        {{ _('Poll closes') }} {{ arrow.get(poll_data.end_poll).humanize(locale=locale) }}.
                    </p>
                {% elif poll_form -%}
                    {% if current_user.is_authenticated -%}
                        <form action='/poll/{{ post.id }}/vote' method="post">
                    {% else -%}
                        <form action='/auth/login' method="get">
                            <input type="hidden" name="next" value="{{ post.slug }}">
                    {% endif -%}
                    <ul>
                        {% for choice in poll_choices -%}
                            {% if poll_data.mode == 'single' -%}
                                <li>
                                    <label for="choice_{{ choice.id }}">
                                        <input type="radio" name="poll_choice" id="choice_{{ choice.id }}" required value="{{ choice.id }}"> {{ choice.choice_text }}
                                    </label>
                                </li>
                            {% else -%}
                                <li>
                                    <label for="choice_{{ choice.id }}">
                                        <input type="checkbox" name="poll_choice[]" id="choice_{{ choice.id }}" value="{{ choice.id }}"> {{ choice.choice_text }}
                                    </label>
                                </li>
                            {% endif -%}
                        {% endfor -%}
                    </ul>
                    {{ form.csrf_token() }}
                    <input type="submit" class="btn btn-primary" value="{{ _('Vote') }}">
                    </form>
                {% endif -%}
            </div>
        {% endif -%}
        {% if post.type == POST_TYPE_EVENT -%}
            <a class="btn btn-sm btn-outline-secondary" style="float: right;" href="{{ url_for('post.show_post_ical', post_id=post.id) }}">
                {{ _('Add to calendar') }}
            </a>
            <small>{{ _('submitted') }} <time datetime="{{ arrow.get(post.posted_at).format('YYYY-MM-DD HH:mm:ss ZZ') }}" title="{{ arrow.get(post.posted_at).format('YYYY-MM-DD HH:mm:ss ZZ') }}">{{ arrow.get(post.posted_at).humanize(locale=locale) }}</time> by
            {% if not post.deleted or post.community.is_moderator() or post.community.is_owner() or current_user.get_id() in admin_ids -%}
                {{ render_username(post.author, htmx_redirect_back_to=request.path, user_notes=user_notes, current_user=current_user, admin_ids=admin_ids, low_bandwidth=low_bandwidth) }}
            {% else -%}
                [{{ _('deleted') }}]
            {% endif -%}
            {% if user_flair and post.author.id in user_flair -%}
                <span class="user_flair">{{ user_flair[post.author.id] }}</span>
            {% elif post.author.id in user_pronouns and user_pronouns[post.author.id] not in post.author.display_name() %}
                <span class="user_flair pronouns">{{ user_pronouns[post.author.id] }}</span>
            {% endif %}
            {% if post.edited_at -%} edited <time datetime="{{ arrow.get(post.posted_at).format('YYYY-MM-DD HH:mm:ss ZZ') }}" title="{{ arrow.get(post.posted_at).format('YYYY-MM-DD HH:mm:ss ZZ') }}">{{ arrow.get(post.edited_at).humanize(locale=locale) }}</time>{% endif -%}</small>
        {% endif -%}
    </div>
    {% if len(post.tags) > 0 -%}
        <nav role="navigation">
            <h3 class="visually-hidden">
                {{ _('Hashtags') }}
            </h3>
            <ul class="post_tags">
                {% for tag in post.tags -%}
                    <li class="post_tag small">
                        <a href="{{ url_for('tag.show_tag', tag=tag.name) }}">
                            #{{ tag.display_as }}
                        </a>
                    </li>
                {% endfor -%}
            </ul>
        </nav>
    {% endif -%}
    {% if len(post.flair) > 0 -%}
        <nav role="navigation">
            <h3 class="visually-hidden">
                {{ _('Flair') }}
            </h3>
            {% for flair in post.flair -%}
                <span class="post_flair me-1" style="color: {{ flair.text_color}}; background-color: {{ flair.background_color }}" title="{{ _('Show only %(flair_name)s', flair_name=flair.flair) }}">
                    <a href="{{ url_for('activitypub.community_profile', actor=post.community.link(), flair=flair.flair) }}" style="color: {{ flair.text_color}}">
                        {{ flair.flair }}
                    </a>
                </span>
            {% endfor -%}
        </nav>
    {% endif -%}
    <div id="post_reactions_{{ post.id }}" class="outermost_reaction_container">
        {%- if post.emoji_reactions -%}
        <div class="message_reactions" id="p_reactions_{{ post.id }}">
            {% for reaction in post.emoji_reactions -%}
                <div class="message_reaction_container me-1">
                    <div class="message_reaction{{ ' reacted' if current_user.is_authenticated and current_user.lemmy_link() in reaction['authors'] }}"
                         hx-post="/post/{{ post.id }}/emoji_set"
                         hx-vals='{"emoji": "{{ reaction['token'] }}"}'
                         hx-target="#p_reactions_{{ post.id }}" hx-swap="outerHTML"
                         title='{{ ", ".join(reaction["authors"]) }}'>
                        <div class="emoji">{% if reaction['url'] and reaction['url'].startswith('https://') -%}
                                                <img src="{{ reaction['url'] }}" width="20" alt="{{ reaction['token'] }}" referrerpolicy="no-referrer">
                                            {% else -%}
                                                {{ reaction['token'] }}
                                            {%- endif %}</div>
                        <div class="message_reaction_count">{{ reaction['count'] }}</div>
                    </div>
                </div>
            {% endfor %}
        </div>
        {%- endif -%}
    </div>
    <div id="ai_check_result"></div>
    <div class="post_utilities_bar">
        <div class="post_reply_count">
            <a href="#post_replies">
                <span class="fe fe-reply"></span><span class="post_reply_count_text"> {{ post.reply_count_cross_posted if post.reply_count_cross_posted else post.reply_count }}</span>
            </a>
        </div>
        <div class="voting_buttons_new" aria-live="assertive" data-base-url="/post/{{ post.id}}">
            {% include "post/_post_voting_buttons.html" -%}
        </div>
        <div class="emoji_button">
            {{ render_post_emoji_button(post, post.community, current_user=current_user, can_upvote_here=can_upvote_here, communities_banned_from_list=communities_banned_from_list, disable_voting=disable_voting, recently_upvoted_replies=recently_upvoted_replies) }}
        </div>
        {% if post.cross_posts -%}
            <div class="cross_post_button">
                <div class="dropdown">
                    <a href="{{ url_for('post.post_cross_posts', post_id=post.id) }}" aria-label="{{ _('Show cross-posts') }}"
                            title="{{ _('Show cross-posts') }}" data-bs-toggle="dropdown" rel="nofollow">
                        <span class="fe fe-layers"></span>
                        <span aria-label="{{ _('Number of cross-posts:') }}">{{ len(post.cross_posts) }}</span>
                    </a>
                    <ul class="dropdown-menu" style="width: 380px; white-space: nowrap; overflow: hidden">
                        <div
                                hx-get="{{ url_for('post.post_cross_posts', post_id=post.id) }}"
                                hx-trigger="intersect once"
                                hx-target="this"
                                hx-swap="outerHTML">
                        </div>
                    </ul>
                </div>
            </div>
        {% endif -%}
        {% if current_user.is_authenticated and post.type == POST_TYPE_LINK or post.type == POST_TYPE_VIDEO -%}
            <div class="post_cross_post_link">
                <a rel="nofollow" aria-label="{{ _('Cross-post') }}" title="{{ _('Cross-post') }}" href="{{ url_for('post.post_cross_post', post_id=post.id) }}">
                    <span class="fe fe-cross-post"></span>
                </a>
            </div>
        {% endif -%}
        {% if post.ap_id -%}
            {% if post.instance_id != 1 -%}
                <div class="post_remote_post_link">
                    <a href="{{ post.ap_id }}" rel="nofollow">
                        <svg class="fediverse_icon" xmlns="http://www.w3.org/2000/svg" style="width: 16px; height: 16px;" viewBox="0 0 196.52 196.52" title="{{ _('View original on %(domain)s', domain=post.instance.domain) }}">
                            <path fill="#a730b8" d="M47.9242 72.7966a18.2278 18.2278 0 0 1-7.7959 7.7597l42.7984 42.9653 10.3182-5.2291zm56.4524 56.6704-10.3182 5.2291 21.686 21.7708a18.2278 18.2278 0 0 1 7.7975-7.7608z"/>
                            <path fill="#5496be" d="M129.6645 102.0765l1.7865 11.4272 27.4149-13.8942a18.2278 18.2278 0 0 1-4.9719-9.8124zm-14.0658 7.1282-57.2891 29.0339a18.2278 18.2278 0 0 1 4.9728 9.8133l54.1027-27.4194z"/>
                            <path fill="#ce3d1a" d="M69.5312 91.6539l8.1618 8.1933 29.269-57.1387a18.2278 18.2278 0 0 1-9.787-5.0219zm-7.1897 14.0363-14.0022 27.3353a18.2278 18.2278 0 0 1 9.786 5.0214l12.3775-24.1639z"/>
                            <path fill="#d0188f" d="M39.8906 80.6763a18.2278 18.2278 0 0 1-10.8655 1.7198l8.1762 52.2981a18.2278 18.2278 0 0 1 10.8645-1.7198z"/>
                            <path fill="#5b36e9" d="M63.3259 148.3109a18.2278 18.2278 0 0 1-1.7322 10.8629l52.2893 8.3907a18.2278 18.2278 0 0 1 1.7322-10.8629z"/>
                            <path fill="#30b873" d="M134.9148 146.9182a18.2278 18.2278 0 0 1 9.788 5.0224l24.1345-47.117a18.2278 18.2278 0 0 1-9.7875-5.0229z"/>
                            <path fill="#ebe305" d="M126.1329 33.1603a18.2278 18.2278 0 0 1-7.7975 7.7608l37.3765 37.5207a18.2278 18.2278 0 0 1 7.7969-7.7608z"/>
                            <path fill="#f47601" d="M44.7704 51.6279a18.2278 18.2278 0 0 1 4.9723 9.8123l47.2478-23.9453a18.2278 18.2278 0 0 1-4.9718-9.8113z"/>
                            <path fill="#57c115" d="M118.2491 40.9645a18.2278 18.2278 0 0 1-10.8511 1.8123l4.1853 26.8 11.42 1.8324zm-4.2333 44.1927 9.8955 63.3631a18.2278 18.2278 0 0 1 10.88-1.6278l-9.355-59.9035z"/>
                            <path fill="#dbb210" d="M49.7763 61.6412a18.2278 18.2278 0 0 1-1.694 10.8686l26.8206 4.3077 5.2715-10.2945zm45.9677 7.382-5.272 10.2955 63.3713 10.1777a18.2278 18.2278 0 0 1 1.7606-10.8593z"/>
                            <path fill="#ffca00" d="M93.4385 23.8419a1 1 0 1 0 33.0924 1.8025 1 1 0 1 0-33.0924-1.8025"/>
                            <path fill="#64ff00" d="M155.314 85.957a1 1 0 1 0 33.0923 1.8025 1 1 0 1 0-33.0923-1.8025"/>
                            <path fill="#00a3ff" d="M115.3466 163.9824a1 1 0 1 0 33.0923 1.8025 1 1 0 1 0-33.0923-1.8025"/>
                            <path fill="#9500ff" d="M28.7698 150.0898a1 1 0 1 0 33.0923 1.8025 1 1 0 1 0-33.0923-1.8025"/>
                            <path fill="#ff0000" d="M15.2298 63.4781a1 1 0 1 0 33.0923 1.8025 1 1 0 1 0-33.0923-1.8025"/>
                        </svg>
                    </a>
                </div>
            {% endif -%}
        {% endif -%}
        <div class="notify_toggle pull-right">
            {% if current_user.is_authenticated and current_user.verified -%}
                {% include 'post/_post_notification_toggle.html' -%}
            {% endif -%}
        </div>
        {% if can_translate and current_user.is_authenticated and current_user.language_id and post.language_id and (current_user.language_id != post.language_id or post.community.always_translate) -%}
            <div class="post_translate_icon">
                <a rel="nofollow noindex" title="{{ _('Translate') }}" href="#"
                        hx-post="{{ url_for('post.post_translate', post_id=post.id) }}"
                        hx-trigger="click throttle:1s" hx-target="previous .post_body" hx-swap="outerHTML">
                    <span class="fe fe-translate"></span>
                </a>
            </div>
        {% endif -%}
        {% if post.community.is_moderator() or post.community.is_owner() or current_user.get_id() in admin_ids -%}
            <div class="dropdown flair_dropdown" id="flair_dropdown_{{ post.id }}">
                <a href="{{ url_for("post.post_set_flair", post_id=post.id) if low_bandwidth else '#' }}"
                        data-bs-toggle="dropdown"
                        rel="nofollow noindex">
                    <span class="fe fe-label" title="{{ _('Set flair') }}"></span>
                </a>
                <ul class="dropdown-menu" style="width: 320px">
                    <div
                            hx-get="{{ url_for('post.post_flair_list', post_id=post.id) }}"
                            hx-trigger="intersect once"
                            hx-target="this"
                            hx-swap="outerHTML">
                    </div>
                </ul>
            </div>
        {% endif -%}
        <div class="post_options_link">
            <div class="dropdown">
                <a href="{{ url_for('post.post_options', post_id=post.id) if low_bandwidth else '#' }}"
                        data-bs-toggle="dropdown" aria-expanded="false" id="post_options_link_{{ post.id }}"
                        rel="nofollow">
                    <span class="fe fe-options" title="Options"></span>
                </a>
                <ul class="dropdown-menu" style="width: 320px" aria-labelledby="post_options_link_{{ post.id }}">
                    <div 
                            hx-get="{{ url_for('post.post_options', post_id=post.id) }}" 
                            hx-trigger="intersect once"
                            hx-target="this"
                            hx-swap="outerHTML">
                    </div>
                </ul>
            </div>
        </div>
    </div>
</div>
